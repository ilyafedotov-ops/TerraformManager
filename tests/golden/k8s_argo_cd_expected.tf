// Generated by TerraformManager â€” Kubernetes Argo CD hardened install


provider "kubernetes" {
  host                   = var.kube_host
  token                  = var.kube_token
  cluster_ca_certificate = base64decode(var.kube_ca)
}

provider "helm" {
  kubernetes {
    host                   = var.kube_host
    token                  = var.kube_token
    cluster_ca_certificate = base64decode(var.kube_ca)
  }
}

variable "kube_host" { description = "https://your-api-server:6443" }
variable "kube_token" { description = "Service account token" }
variable "kube_ca"    { description = "Base64-encoded cluster CA" }

locals {
  namespace_labels = {
    managed_by   = "TerraformManager"
    environment  = "prod"
    team         = "platform"
    "pod-security.kubernetes.io/enforce"         = "restricted"
    "pod-security.kubernetes.io/enforce-version" = "latest"
    "pod-security.kubernetes.io/audit"           = "restricted"
    "pod-security.kubernetes.io/warn"            = "baseline"
  }
}

resource "kubernetes_namespace" "argocd_ns" {
  metadata {
    name   = "argocd"
    labels = local.namespace_labels
  }
}

resource "kubernetes_network_policy" "argocd_ns_baseline" {
  metadata {
    name      = "argocd-baseline"
    namespace = kubernetes_namespace.argocd_ns.metadata[0].name
    labels = {
      managed_by = "TerraformManager"
    }
  }
  spec {
    pod_selector {}
    ingress {
      from {
        pod_selector {}
      }

      from {
        ip_block {
          cidr = "10.0.0.0/24"
        }
      }

    }
    egress {
      to {
        namespace_selector {
          match_labels = {
            "kubernetes.io/metadata.name" = "kube-system"
          }
        }
      }
      ports {
        port     = 53
        protocol = "UDP"
      }
      ports {
        port     = 53
        protocol = "TCP"
      }
    }

    
    egress {
      to {
        ip_block { cidr = "10.0.0.0/24" }
      }
    }
    

    policy_types = ["Ingress", "Egress"]
  }
}


resource "kubernetes_resource_quota" "argocd_ns_quota" {
  metadata {
    name      = "argocd-quota"
    namespace = kubernetes_namespace.argocd_ns.metadata[0].name
  }
  spec {
    hard = {
      "requests.cpu"    = "10"
      "requests.memory" = "32Gi"
      "limits.cpu"      = "20"
      "limits.memory"   = "64Gi"
      "pods"            = "200"
    }
  }
}


resource "helm_release" "argocd_release" {
  name       = "argocd"
  repository = "https://argoproj.github.io/argo-helm"
  chart      = "argo-cd"
  version    = "5.46.6"
  namespace  = kubernetes_namespace.argocd_ns.metadata[0].name
  create_namespace = false
  cleanup_on_fail  = true
  timeout          = 600

  values = [
    yamlencode({
      global = {
        addPrometheusAnnotations = false
        securityContext = {
          runAsNonRoot = true
          runAsUser    = 999
          fsGroup      = 999
        }
        networkPolicy = {
          create = true
        }
      }
      configs = {
        cm = {
          "accounts.admin.enabled" = "false"
          "exec.enabled"           = "false"
          "server.rbac.log.enforce.enable" = "true"
          "url"                    = "https://argocd.example.com"
        }
        params = {
          "server.insecure"            = "false"
          "server.disable.auth"        = "false"
          "applicationsetcontroller.enabled" = "true"
          "controller.diff.server.side" = "false"
        }
      }
      controller = {
        replicas = 2
        podSecurityContext = {
          runAsNonRoot = true
          runAsUser    = 999
          fsGroup      = 999
        }
        containerSecurityContext = {
          allowPrivilegeEscalation = false
          readOnlyRootFilesystem   = true
          capabilities = {
            drop = ["ALL"]
          }
        }
        metrics = { enabled = false }
      }
      server = {
        autoscaling = { enabled = false }
        service = {
          type = "ClusterIP"
        }
        podSecurityContext = {
          runAsNonRoot = true
          runAsUser    = 999
          fsGroup      = 999
        }
        containerSecurityContext = {
          allowPrivilegeEscalation = false
          readOnlyRootFilesystem   = true
          capabilities = {
            drop = ["ALL"]
          }
        }

        ingress = {
          enabled = true

          ingressClassName = "nginx"

          hosts = [
            {
              host  = "argocd.example.com"
              paths = [{ path = "/", pathType = "Prefix" }]
            }
          ]

          tls = [
            {
              hosts      = ["argocd.example.com"]
              secretName = "argocd-server-tls"
            }
          ]

        }

      }
      repoServer = {
        podSecurityContext = {
          runAsNonRoot = true
          runAsUser    = 999
          fsGroup      = 999
        }
        containerSecurityContext = {
          allowPrivilegeEscalation = false
          readOnlyRootFilesystem   = true
          capabilities = {
            drop = ["ALL"]
          }
        }
        env = [
          {
            name  = "ARGOCD_GPG_ENABLED"
            value = "true"
          }
        ]
      }
      applicationSet = {
        enabled = true
      }
      dex = {
        enabled = false
      }
      redis = {
        metrics = {
          enabled = false
        }
      }
    })
  ]

  depends_on = [
    kubernetes_namespace.argocd_ns,
    kubernetes_network_policy.argocd_ns_baseline,
    kubernetes_resource_quota.argocd_ns_quota
  ]
}

output "argocd_release_namespace" {
  description = "Namespace where Argo CD is installed"
  value       = kubernetes_namespace.argocd_ns.metadata[0].name
}

output "argocd_release_server_service" {
  description = "Internal service name for Argo CD API server"
  value       = "argocd-server.${kubernetes_namespace.argocd_ns.metadata[0].name}.svc.cluster.local"
}