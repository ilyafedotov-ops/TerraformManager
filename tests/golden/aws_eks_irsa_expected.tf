// Generated by TerraformManager â€” AWS EKS IRSA service module


provider "aws" {
  region = "us-east-1"
}

data "aws_eks_cluster" "app_eks_cluster_data" {
  name = "app-eks"
}

data "aws_eks_cluster_auth" "app_eks_cluster_data" {
  name = data.aws_eks_cluster.app_eks_cluster_data.name
}

provider "kubernetes" {
  host                   = data.aws_eks_cluster.app_eks_cluster_data.endpoint
  cluster_ca_certificate = base64decode(data.aws_eks_cluster.app_eks_cluster_data.certificate_authority[0].data)
  token                  = data.aws_eks_cluster_auth.app_eks_cluster_data.token
}

locals {
  common_tags = {
    ManagedBy   = "TerraformManager"
    Environment = "prod"
    Owner       = "platform"
    CostCenter  = "ENG"
  }

  psa_labels = {
    "pod-security.kubernetes.io/enforce" = "restricted"
    "pod-security.kubernetes.io/audit"   = "restricted"
    "pod-security.kubernetes.io/warn"    = "baseline"
  }
}


resource "kubernetes_namespace" "app" {
  metadata {
    name = "app"
    labels = merge(
      local.psa_labels,
      {
        "app.kubernetes.io/managed-by" = "TerraformManager"
        "kubernetes.io/metadata.name"  = "app"
      }
    )
  }
}


resource "aws_iam_role" "app_sa_irsa_role" {
  name = "app-sa-irsa-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Federated = "arn:aws:iam::123456789012:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/EXAMPLE"
        }
        Action = "sts:AssumeRoleWithWebIdentity"
        Condition = {
          "StringEquals" = {
            "oidc.eks.us-east-1.amazonaws.com/id/EXAMPLE:sub" = "system:serviceaccount:app:app-sa"
          }
          "StringLike" = {
            "oidc.eks.us-east-1.amazonaws.com/id/EXAMPLE:aud" = "sts.amazonaws.com"
          }
        }
      }
    ]
  })

  tags = local.common_tags
}

resource "aws_iam_role_policy" "app_sa_irsa_policy" {
  name = "app-sa-access"
  role = aws_iam_role.app_sa_irsa_role.id

  policy = <<POLICY
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ApplicationAccess",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject"
      ],
      "Resource": [
        "arn:aws:s3:::example-bucket/*"
      ]
    }
  ]
}
POLICY
}

resource "kubernetes_service_account" "app_sa" {
  metadata {
    name      = "app-sa"
    namespace = "app"
    labels = {
      "app.kubernetes.io/name"       = "app-sa"
      "app.kubernetes.io/managed-by" = "TerraformManager"
    }
    annotations = {
      "eks.amazonaws.com/role-arn" = aws_iam_role.app_sa_irsa_role.arn
    }
  }

  depends_on = [kubernetes_namespace.app]

}

output "app_sa_irsa_role_arn" {
  description = "IAM role ARN for service account app-sa"
  value       = aws_iam_role.app_sa_irsa_role.arn
}

output "app_sa_name" {
  description = "Kubernetes service account"
  value       = "${data.aws_eks_cluster.app_eks_cluster_data.name}/app/app-sa"
}