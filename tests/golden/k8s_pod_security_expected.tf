// Generated by TerraformManager â€” Kubernetes PodSecurity baseline


provider "kubernetes" {
  host                   = var.kube_host
  token                  = var.kube_token
  cluster_ca_certificate = base64decode(var.kube_ca)
}

variable "kube_host" { description = "https://your-api-server:6443" }
variable "kube_token" { description = "Service account token" }
variable "kube_ca"    { description = "Base64-encoded cluster CA" }

resource "kubernetes_pod_security_policy" "policy" {
  metadata {
    name = "restricted"
    labels = {
      app       = "restricted"
      managedBy = "TerraformManager"
    }
  }
  spec {
    privileged                 = false
    allow_privilege_escalation = false
    required_drop_capabilities = ["ALL"]
    read_only_root_filesystem  = true
    run_as_user {
      rule = "MustRunAsNonRoot"
    }
    se_linux {
      rule = "RunAsAny"
    }
    fs_group {
      rule = "MustRunAs"
      ranges {
        min = 1
        max = 65535
      }
    }
    supplemental_group {
      rule = "MustRunAs"
      ranges {
        min = 1
        max = 65535
      }
    }
    volumes = ["configMap", "emptyDir", "projected", "secret", "downwardAPI", "persistentVolumeClaim"]
  }
}

resource "kubernetes_cluster_role" "policy" {
  metadata {
    name = "use-restricted"
  }
  rule {
    api_groups = ["extensions"]
    resources  = ["podsecuritypolicies"]
    verbs      = ["use"]
    resource_names = [kubernetes_pod_security_policy.policy.metadata[0].name]
  }
}

resource "kubernetes_cluster_role_binding" "policy" {
  metadata {
    name = "use-restricted"
  }
  role_ref {
    api_group = "rbac.authorization.k8s.io"
    kind      = "ClusterRole"
    name      = kubernetes_cluster_role.policy.metadata[0].name
  }
  subject {
    kind      = "ServiceAccount"
    name      = "default"
    namespace = "default"
  }
}

resource "kubernetes_namespace" "ns" {
  metadata {
    name = "restricted"
    labels = {
      managed_by                             = "TerraformManager"
      "pod-security.kubernetes.io/enforce"  = "restricted"
      "pod-security.kubernetes.io/enforce-version" = "latest"
      "pod-security.kubernetes.io/audit"    = "restricted"
      "pod-security.kubernetes.io/warn"     = "baseline"
    }
  }
}