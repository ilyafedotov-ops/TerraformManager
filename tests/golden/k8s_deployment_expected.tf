// Generated by TerraformManager (On‑Prem default via Kubernetes provider)


provider "kubernetes" {
  host                   = var.kube_host
  token                  = var.kube_token
  cluster_ca_certificate = base64decode(var.kube_ca)
}

variable "kube_host" { description = "https://your-api-server:6443" }
variable "kube_token" { description = "Service account token" }
variable "kube_ca"    { description = "Base64‑encoded cluster CA" }

resource "kubernetes_namespace" "ns" {
  metadata {
    name = "apps"
    labels = {
      managed_by  = "TerraformManager"
      environment = "prod"
      team        = "platform"
    }
  }
}

resource "kubernetes_deployment" "deploy" {
  metadata {
    name      = "web"
    namespace = kubernetes_namespace.ns.metadata[0].name
    labels = {
      app         = "web"
      environment = "prod"
      team        = "platform"
      tier        = "backend"
      managed_by  = "TerraformManager"
    }
  }
  spec {
    replicas = 2
    selector {
      match_labels = {
        app = "web"
      }
    }
    template {
      metadata {
        labels = {
          app         = "web"
          environment = "prod"
          team        = "platform"
          tier        = "backend"
          managed_by  = "TerraformManager"
        }
        
        annotations = {
          "container.apparmor.security.beta.kubernetes.io/web" = "runtime/default"
        }
        
      }
      spec {
        container {
          name  = "web"
          image = "nginx:1.25.3"
          port { container_port = 80 }
          security_context {
            
            run_as_non_root           = true
            read_only_root_filesystem = true
            
            
            seccomp_profile {
              type = "RuntimeDefault"
            }
            
            capabilities {
              drop = ["ALL"]
            }
          }
          
          resources {
            limits = { cpu = "500m", memory = "256Mi" }
            requests = { cpu = "250m", memory = "128Mi" }
          }
          
        }
      }
    }
  }
}