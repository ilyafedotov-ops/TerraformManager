// Generated by TerraformManager â€” Azure Function App baseline
provider "azurerm" {
  features {}
}

{%- if rg_name != "rg" %}
moved {
  from = azurerm_resource_group.rg
  to   = azurerm_resource_group.{{ rg_name }}
}

{%- endif %}

{%- if storage_name != "storage" %}
moved {
  from = azurerm_storage_account.storage
  to   = azurerm_storage_account.{{ storage_name }}
}

{%- endif %}

{%- if plan_name != "plan" %}
moved {
  from = azurerm_service_plan.plan
  to   = azurerm_service_plan.{{ plan_name }}
}

{%- endif %}

{%- if function_name != "func" %}
moved {
  from = azurerm_linux_function_app.func
  to   = azurerm_linux_function_app.{{ function_name }}
}

{%- endif %}

{%- if enable_application_insights and insights_name != "insights" %}
moved {
  from = azurerm_application_insights.insights
  to   = azurerm_application_insights.{{ insights_name }}
}

{%- endif %}

locals {
  tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

resource "azurerm_resource_group" "{{ rg_name }}" {
  name     = "{{ rg_actual_name }}"
  location = "{{ location }}"
  tags     = local.tags
}

resource "azurerm_storage_account" "{{ storage_name }}" {
  name                     = "{{ storage_actual_name }}"
  resource_group_name      = azurerm_resource_group.{{ rg_name }}.name
  location                 = azurerm_resource_group.{{ rg_name }}.location
  account_tier             = "Standard"
  account_replication_type = "{{ storage_replication }}"
  min_tls_version          = "TLS1_2"
  allow_nested_items_to_be_public = false
  https_traffic_only_enabled      = true
  account_kind             = "StorageV2"
  tags = local.tags
}

{% if enable_application_insights %}
resource "azurerm_application_insights" "{{ insights_name }}" {
  name                = "{{ insights_actual_name }}"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  application_type    = "web"
  retention_in_days   = 90
  tags                = local.tags
}
{% endif %}

resource "azurerm_service_plan" "{{ plan_name }}" {
  name                = "{{ plan_actual_name }}"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  os_type             = "Linux"
  sku_name            = "{{ app_service_plan_sku }}"
  worker_count        = 1
  kind                = "FunctionApp"
  tags                = local.tags
}

resource "azurerm_linux_function_app" "{{ function_name }}" {
  name                       = "{{ function_actual_name }}"
  location                   = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name        = azurerm_resource_group.{{ rg_name }}.name
  service_plan_id            = azurerm_service_plan.{{ plan_name }}.id
  storage_account_name       = azurerm_storage_account.{{ storage_name }}.name
  storage_account_access_key = azurerm_storage_account.{{ storage_name }}.primary_access_key
  https_only                 = true
  functions_extension_version = "~4"
  identity {
    type = "SystemAssigned"
  }
  {% if enable_vnet_integration %}
  virtual_network_subnet_id = "{{ vnet_subnet_id }}"
  {% endif %}

  app_settings = {
    FUNCTIONS_WORKER_RUNTIME        = "{{ runtime }}"
    FUNCTIONS_EXTENSION_VERSION     = "~4"
    WEBSITE_RUN_FROM_PACKAGE        = "1"
    AzureWebJobsStorage             = azurerm_storage_account.{{ storage_name }}.primary_connection_string
    {% if enable_application_insights %}
    APPINSIGHTS_INSTRUMENTATIONKEY  = azurerm_application_insights.{{ insights_name }}.instrumentation_key
    APPLICATIONINSIGHTS_CONNECTION_STRING = azurerm_application_insights.{{ insights_name }}.connection_string
    {% endif %}
  }

  site_config {
    ftps_state             = "Disabled"
    minimum_tls_version    = "1.2"
    application_stack {
      {% if application_stack.dotnet_version %}
      dotnet_version = "{{ application_stack.dotnet_version }}"
      {% endif %}
      {% if application_stack.node_version %}
      node_version = "{{ application_stack.node_version }}"
      {% endif %}
      {% if application_stack.python_version %}
      python_version = "{{ application_stack.python_version }}"
      {% endif %}
      {% if application_stack.java_version %}
      java_version = "{{ application_stack.java_version }}"
      {% endif %}
    }
  }

  tags = local.tags
}

{% if diagnostics %}
resource "azurerm_monitor_diagnostic_setting" "{{ function_name }}_diag" {
  name                       = "{{ function_actual_name }}-diag"
  target_resource_id         = azurerm_linux_function_app.{{ function_name }}.id
  log_analytics_workspace_id = "{{ diagnostics.workspace_resource_id }}"

  dynamic "log" {
    for_each = {{ diagnostics.log_categories_literal }}
    content {
      category = log.value
      enabled  = true
    }
  }

  dynamic "metric" {
    for_each = {{ diagnostics.metric_categories_literal }}
    content {
      category = metric.value
      enabled  = true
    }
  }
}
{% endif %}

output "function_app_name" {
  value       = azurerm_linux_function_app.{{ function_name }}.name
  description = "Name of the Function App."
}

output "function_app_identity_principal_id" {
  value       = azurerm_linux_function_app.{{ function_name }}.identity[0].principal_id
  description = "Managed identity principal ID."
}
