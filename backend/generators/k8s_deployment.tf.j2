// Generated by TerraformManager (On‑Prem default via Kubernetes provider)
{% if backend %}
terraform {
  backend "s3" {
    endpoint                    = "{{ backend.endpoint }}"
    bucket                      = "{{ backend.bucket }}"
    key                         = "{{ backend.key }}"
    region                      = "{{ backend.region }}"
    skip_credentials_validation = true
    skip_region_validation      = true
    force_path_style            = true
  }
}
{% endif %}

provider "kubernetes" {
  host                   = var.kube_host
  token                  = var.kube_token
  cluster_ca_certificate = base64decode(var.kube_ca)
}

variable "kube_host" { description = "https://your-api-server:6443" }
variable "kube_token" { description = "Service account token" }
variable "kube_ca"    { description = "Base64‑encoded cluster CA" }

resource "kubernetes_namespace" "{{ namespace_name }}" {
  metadata {
    name = "{{ namespace_actual }}"
    labels = {
      managed_by  = "TerraformManager"
      environment = "{{ environment }}"
      team        = "{{ team_label }}"
    }
  }
}

resource "kubernetes_deployment" "{{ app_name }}" {
  metadata {
    name      = "{{ app_actual }}"
    namespace = kubernetes_namespace.{{ namespace_name }}.metadata[0].name
    labels = {
      app         = "{{ app_actual }}"
      environment = "{{ environment }}"
      team        = "{{ team_label }}"
      tier        = "{{ tier_label }}"
      managed_by  = "TerraformManager"
    }
  }
  spec {
    replicas = {{ replicas }}
    selector {
      match_labels = {
        app = "{{ app_actual }}"
      }
    }
    template {
      metadata {
        labels = {
          app         = "{{ app_actual }}"
          environment = "{{ environment }}"
          team        = "{{ team_label }}"
          tier        = "{{ tier_label }}"
          managed_by  = "TerraformManager"
        }
        {% if enforce_apparmor %}
        annotations = {
          "container.apparmor.security.beta.kubernetes.io/{{ app_actual }}" = "runtime/default"
        }
        {% endif %}
      }
      spec {
        container {
          name  = "{{ app_actual }}"
          image = "{{ image }}"
          port { container_port = {{ container_port }} }
          security_context {
            {% if non_root %}
            run_as_non_root           = true
            read_only_root_filesystem = true
            {% endif %}
            {% if enforce_seccomp %}
            seccomp_profile {
              type = "RuntimeDefault"
            }
            {% endif %}
            capabilities {
              drop = ["ALL"]
            }
          }
          {% if set_limits %}
          resources {
            limits = { cpu = "{{ cpu_limit }}", memory = "{{ mem_limit }}" }
            requests = { cpu = "{{ cpu_request }}", memory = "{{ mem_request }}" }
          }
          {% endif %}
        }
      }
    }
  }
}
