// Generated by TerraformManager
{% if backend %}
terraform {
  backend "azurerm" {
    resource_group_name  = "{{ backend.resource_group }}"
    storage_account_name = "{{ backend.storage_account }}"
    container_name       = "{{ backend.container }}"
    key                  = "{{ backend.key }}"
  }
}
{% endif %}

provider "azurerm" { features {} }

resource "azurerm_resource_group" "{{ rg_name }}" {
  name     = "{{ rg_actual_name }}"
  location = "{{ location }}"
  tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

resource "azurerm_storage_account" "{{ sa_name }}" {
  name                     = "{{ sa_actual_name }}"
  resource_group_name      = azurerm_resource_group.{{ rg_name }}.name
  location                 = azurerm_resource_group.{{ rg_name }}.location
  account_tier             = "Standard"
  account_replication_type = "{{ replication }}"
  allow_blob_public_access  = false
  enable_https_traffic_only = true
  min_tls_version           = "TLS1_2"
  blob_properties {
    versioning_enabled = {{ "true" if versioning else "false" }}
  }
  {% if restrict_network %}
  network_rules {
    default_action             = "Deny"
    bypass                     = ["AzureServices"]
    ip_rules                   = {{ ip_rules_literal }}
  }
  {% endif %}
  tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

{% if private_endpoint %}
resource "azurerm_private_endpoint" "{{ private_endpoint.resource_name }}" {
  name                = "{{ private_endpoint.name }}"
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  location            = azurerm_resource_group.{{ rg_name }}.location
  subnet_id           = "{{ private_endpoint.subnet_id }}"

  private_service_connection {
    name                           = "{{ private_endpoint.connection_name }}"
    private_connection_resource_id = azurerm_storage_account.{{ sa_name }}.id
    subresource_names              = ["blob"]
    is_manual_connection           = false
  }

  {% if private_endpoint.private_dns_zone_id %}
  private_dns_zone_group {
    name                 = "{{ private_endpoint.dns_zone_group_name }}"
    private_dns_zone_ids = ["{{ private_endpoint.private_dns_zone_id }}"]
  }
  {% endif %}

  tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

output "storage_private_endpoint_id" {
  value       = azurerm_private_endpoint.{{ private_endpoint.resource_name }}.id
  description = "Resource ID for the storage account private endpoint."
}
{% endif %}
