// Generated by TerraformManager â€” Azure Service Bus namespace
{% if backend %}
terraform {
  backend "azurerm" {
    resource_group_name  = "{{ backend.resource_group }}"
    storage_account_name = "{{ backend.storage_account }}"
    container_name       = "{{ backend.container }}"
    key                  = "{{ backend.key }}"
  }
}
{% endif %}

provider "azurerm" {
  features {}
}

{%- if rg_name != "rg" %}
moved {
  from = azurerm_resource_group.rg
  to   = azurerm_resource_group.{{ rg_name }}
}

{%- endif %}

{%- if namespace_name != "namespace" %}
moved {
  from = azurerm_servicebus_namespace.namespace
  to   = azurerm_servicebus_namespace.{{ namespace_name }}
}

{%- if diagnostics %}
moved {
  from = azurerm_monitor_diagnostic_setting.namespace_diag
  to   = azurerm_monitor_diagnostic_setting.{{ namespace_name }}_diag
}

{%- endif %}

{%- if private_endpoint %}
moved {
  from = azurerm_private_endpoint.namespace_pe
  to   = azurerm_private_endpoint.{{ namespace_name }}_pe
}

{%- endif %}

{%- endif %}

locals {
  tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

resource "azurerm_resource_group" "{{ rg_name }}" {
  name     = "{{ rg_actual_name }}"
  location = "{{ location }}"
  tags     = local.tags
}

resource "azurerm_servicebus_namespace" "{{ namespace_name }}" {
  name                = "{{ namespace_actual_name }}"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  sku                 = "{{ sku }}"
{% if capacity is not none %}
  capacity            = {{ capacity }}
{% endif %}
  zone_redundant      = {{ "true" if zone_redundant else "false" }}
  public_network_access_enabled = {{ "false" if restrict_network else "true" }}
  minimum_tls_version = "1.2"
  tags                = local.tags

  identity {
    type = "{{ identity.type }}"
{% if identity.user_assigned_identity_ids %}
    identity_ids = [
{% for identity_id in identity.user_assigned_identity_ids %}
      "{{ identity_id }}",
{% endfor %}
    ]
{% endif %}
  }

{% if customer_managed_key %}
  customer_managed_key {
    key_vault_key_id = "{{ customer_managed_key.key_vault_key_id }}"
{% if customer_managed_key.user_assigned_identity_id %}
    user_assigned_identity_id = "{{ customer_managed_key.user_assigned_identity_id }}"
{% endif %}
  }
{% endif %}
}

{% for queue in queues %}
resource "azurerm_servicebus_queue" "{{ queue.resource_name }}" {
  name                = "{{ queue.name }}"
  namespace_id        = azurerm_servicebus_namespace.{{ namespace_name }}.id
  enable_partitioning = {{ "true" if queue.enable_partitioning else "false" }}
  lock_duration       = "{{ queue.lock_duration }}"
  max_delivery_count  = {{ queue.max_delivery_count }}
  requires_duplicate_detection = {{ "true" if queue.requires_duplicate_detection else "false" }}
  duplicate_detection_history_time_window = "{{ queue.duplicate_detection_history_time_window }}"
}

{% endfor %}
{% for topic in topics %}
resource "azurerm_servicebus_topic" "{{ topic.resource_name }}" {
  name                = "{{ topic.name }}"
  namespace_id        = azurerm_servicebus_namespace.{{ namespace_name }}.id
  enable_partitioning = {{ "true" if topic.enable_partitioning else "false" }}
  default_message_ttl = "{{ topic.default_message_ttl }}"
  requires_duplicate_detection = {{ "true" if topic.requires_duplicate_detection else "false" }}
  duplicate_detection_history_time_window = "{{ topic.duplicate_detection_history_time_window }}"
}

{% for subscription in topic.subscriptions %}
resource "azurerm_servicebus_subscription" "{{ subscription.resource_name }}" {
  name                = "{{ subscription.name }}"
  topic_id            = azurerm_servicebus_topic.{{ topic.resource_name }}.id
  requires_session    = {{ "true" if subscription.requires_session else "false" }}
  lock_duration       = "{{ subscription.lock_duration }}"
  max_delivery_count  = {{ subscription.max_delivery_count }}
{% if subscription.forward_to %}
  forward_to          = "{{ subscription.forward_to }}"
{% endif %}
}

{% endfor %}
{% endfor %}
{% if diagnostics %}
resource "azurerm_monitor_diagnostic_setting" "{{ namespace_name }}_diag" {
  name               = "{{ namespace_actual_name }}-diag"
  target_resource_id = azurerm_servicebus_namespace.{{ namespace_name }}.id
  log_analytics_workspace_id = "{{ diagnostics.workspace_resource_id }}"

  dynamic "log" {
    for_each = {{ diagnostics.log_categories_literal }}
    content {
      category = log.value
      enabled  = true
    }
  }

  dynamic "metric" {
    for_each = {{ diagnostics.metric_categories_literal }}
    content {
      category = metric.value
      enabled  = true
    }
  }
}

{% endif %}
{% if private_endpoint %}
resource "azurerm_private_endpoint" "{{ namespace_name }}_pe" {
  name                = "{{ private_endpoint.name }}"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  subnet_id           = "{{ private_endpoint.subnet_id }}"
  tags                = local.tags

  private_service_connection {
    name                           = "{{ private_endpoint.name }}-psc"
    private_connection_resource_id = azurerm_servicebus_namespace.{{ namespace_name }}.id
    is_manual_connection           = false
    subresource_names              = {{ private_endpoint.group_ids_literal }}
  }

{% if private_endpoint.private_dns_zone_ids_literal != "[]" %}
  private_dns_zone_group {
    name                 = "{{ private_endpoint.name }}-dns"
    private_dns_zone_ids = {{ private_endpoint.private_dns_zone_ids_literal }}
  }
{% endif %}
}

{% endif %}
