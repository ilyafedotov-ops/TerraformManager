// Generated by TerraformManager â€” Kubernetes namespace baseline
{% if backend %}
terraform {
  backend "s3" {
    endpoint                    = "{{ backend.endpoint }}"
    bucket                      = "{{ backend.bucket }}"
    key                         = "{{ backend.key }}"
    region                      = "{{ backend.region }}"
    skip_credentials_validation = true
    skip_region_validation      = true
    force_path_style            = true
  }
}
{% endif %}

provider "kubernetes" {
  host                   = var.kube_host
  token                  = var.kube_token
  cluster_ca_certificate = base64decode(var.kube_ca)
}

variable "kube_host" { description = "https://your-api-server:6443" }
variable "kube_token" { description = "Service account token" }
variable "kube_ca"    { description = "Base64-encoded cluster CA" }

locals {
  labels = {
    managed_by  = "TerraformManager"
    environment = "{{ environment }}"
    team        = "{{ team_label }}"
  }
}

resource "kubernetes_namespace" "{{ namespace_name }}" {
  metadata {
    name   = "{{ namespace_actual }}"
    labels = local.labels
  }
}

resource "kubernetes_resource_quota" "{{ namespace_name }}_quota" {
  metadata {
    name      = "{{ namespace_actual }}-quota"
    namespace = kubernetes_namespace.{{ namespace_name }}.metadata[0].name
    labels    = local.labels
  }

  spec {
    hard = {
      "limits.cpu"      = "{{ quota_limits_cpu }}"
      "limits.memory"   = "{{ quota_limits_memory }}"
      "requests.cpu"    = "{{ quota_requests_cpu }}"
      "requests.memory" = "{{ quota_requests_memory }}"
      "pods"            = "{{ quota_pods }}"
    }
  }
}

resource "kubernetes_limit_range" "{{ namespace_name }}_limits" {
  metadata {
    name      = "{{ namespace_actual }}-limits"
    namespace = kubernetes_namespace.{{ namespace_name }}.metadata[0].name
    labels    = local.labels
  }

  spec {
    limit {
      type = "Container"
      max = {
        cpu    = "{{ limit_max_cpu }}"
        memory = "{{ limit_max_memory }}"
      }
      min = {
        cpu    = "{{ limit_min_cpu }}"
        memory = "{{ limit_min_memory }}"
      }
      default = {
        cpu    = "{{ limit_default_cpu }}"
        memory = "{{ limit_default_memory }}"
      }
      default_request = {
        cpu    = "{{ limit_default_request_cpu }}"
        memory = "{{ limit_default_request_memory }}"
      }
    }
  }
}

resource "kubernetes_network_policy" "{{ namespace_name }}_default_deny" {
  metadata {
    name      = "{{ namespace_actual }}-default-deny"
    namespace = kubernetes_namespace.{{ namespace_name }}.metadata[0].name
    labels    = local.labels
  }

  spec {
    pod_selector {}
    policy_types = ["Ingress", "Egress"]

    ingress {
      from {
        namespace_selector {
          match_labels = {
            "kubernetes.io/metadata.name" = "{{ namespace_actual }}"
          }
        }
      }
    }

    egress {
      to {
        namespace_selector {
          match_labels = {
            "kubernetes.io/metadata.name" = "{{ namespace_actual }}"
          }
        }
      }
    }
  }
}
