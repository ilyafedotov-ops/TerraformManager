// Generated by TerraformManager â€” AWS VPC baseline
{% if backend %}
terraform {
  backend "s3" {
    bucket         = "{{ backend.bucket }}"
    key            = "{{ backend.key }}"
    region         = "{{ region }}"
    dynamodb_table = "{{ backend.dynamodb_table }}"
    encrypt        = true
  }
}
{% endif %}

provider "aws" {
  region = "{{ region }}"
}

locals {
  common_tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

resource "aws_vpc" "{{ vpc_name }}" {
  cidr_block           = "{{ vpc_cidr }}"
  enable_dns_hostnames = true
  enable_dns_support   = true
  tags = merge(local.common_tags, {
    Name = "{{ name_prefix }}-vpc"
  })
}

resource "aws_flow_log" "{{ vpc_name }}_flow_logs" {
  log_destination      = aws_cloudwatch_log_group.{{ vpc_name }}_flow_logs.arn
  log_destination_type = "cloud-watch-logs"
  traffic_type         = "ALL"
  vpc_id               = aws_vpc.{{ vpc_name }}.id
  iam_role_arn         = aws_iam_role.{{ vpc_name }}_flow_logs_role.arn
  tags = merge(local.common_tags, {
    Name = "{{ name_prefix }}-flow-logs"
  })
}

resource "aws_cloudwatch_log_group" "{{ vpc_name }}_flow_logs" {
  name              = "/aws/vpc/{{ name_prefix }}/flow-logs"
  retention_in_days = {{ flow_logs_retention_days }}
  tags              = local.common_tags
}

resource "aws_iam_role" "{{ vpc_name }}_flow_logs_role" {
  name = "{{ name_prefix }}-flow-logs-role"
  assume_role_policy = <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "vpc-flow-logs.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF
  tags = local.common_tags
}

resource "aws_iam_role_policy" "{{ vpc_name }}_flow_logs_policy" {
  name = "{{ name_prefix }}-flow-logs-policy"
  role = aws_iam_role.{{ vpc_name }}_flow_logs_role.id
  policy = <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "${aws_cloudwatch_log_group.{{ vpc_name }}_flow_logs.arn}:*"
    }
  ]
}
EOF
}

resource "aws_internet_gateway" "{{ vpc_name }}_igw" {
  vpc_id = aws_vpc.{{ vpc_name }}.id
  tags = merge(local.common_tags, {
    Name = "{{ name_prefix }}-igw"
  })
}

resource "aws_nat_gateway" "{{ vpc_name }}_nat" {
  allocation_id = aws_eip.{{ vpc_name }}_nat.id
  subnet_id     = aws_subnet.{{ private_subnet_name }}_public.id
  tags = merge(local.common_tags, {
    Name = "{{ name_prefix }}-nat"
  })
  depends_on = [aws_internet_gateway.{{ vpc_name }}_igw]
}

resource "aws_eip" "{{ vpc_name }}_nat" {
  vpc  = true
  tags = merge(local.common_tags, { Name = "{{ name_prefix }}-nat-eip" })
}

resource "aws_subnet" "{{ private_subnet_name }}_public" {
  vpc_id                  = aws_vpc.{{ vpc_name }}.id
  cidr_block              = "{{ public_subnet_cidr }}"
  map_public_ip_on_launch = true
  availability_zone       = "{{ public_subnet_az }}"
  tags = merge(local.common_tags, {
    Name = "{{ name_prefix }}-public"
    Tier = "public"
  })
}

resource "aws_subnet" "{{ private_subnet_name }}_private" {
  vpc_id            = aws_vpc.{{ vpc_name }}.id
  cidr_block        = "{{ private_subnet_cidr }}"
  availability_zone = "{{ private_subnet_az }}"
  tags = merge(local.common_tags, {
    Name = "{{ name_prefix }}-private"
    Tier = "private"
  })
}

resource "aws_route_table" "{{ vpc_name }}_public" {
  vpc_id = aws_vpc.{{ vpc_name }}.id
  tags = merge(local.common_tags, { Name = "{{ name_prefix }}-public-rt" })

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.{{ vpc_name }}_igw.id
  }
}

resource "aws_route_table_association" "{{ vpc_name }}_public" {
  subnet_id      = aws_subnet.{{ private_subnet_name }}_public.id
  route_table_id = aws_route_table.{{ vpc_name }}_public.id
}

resource "aws_route_table" "{{ vpc_name }}_private" {
  vpc_id = aws_vpc.{{ vpc_name }}.id
  tags = merge(local.common_tags, { Name = "{{ name_prefix }}-private-rt" })

  route {
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.{{ vpc_name }}_nat.id
  }
}

resource "aws_route_table_association" "{{ vpc_name }}_private" {
  subnet_id      = aws_subnet.{{ private_subnet_name }}_private.id
  route_table_id = aws_route_table.{{ vpc_name }}_private.id
}

resource "aws_security_group" "{{ private_subnet_name }}_baseline" {
  name        = "{{ name_prefix }}-baseline"
  description = "Baseline SG allowing VPC internal traffic and egress via NAT"
  vpc_id      = aws_vpc.{{ vpc_name }}.id
  tags = merge(local.common_tags, {
    Name = "{{ name_prefix }}-sg"
  })

  ingress {
    description = "Allow VPC internal"
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = [aws_vpc.{{ vpc_name }}.cidr_block]
  }

  egress {
    description = "Allow egress via NAT"
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}
