// Generated by TerraformManager â€” Azure AKS baseline
{% if backend %}
terraform {
  backend "azurerm" {
    resource_group_name  = "{{ backend.resource_group }}"
    storage_account_name = "{{ backend.storage_account }}"
    container_name       = "{{ backend.container }}"
    key                  = "{{ backend.key }}"
  }
}
{% endif %}

provider "azurerm" {
  features {}
}

locals {
  tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

resource "azurerm_resource_group" "{{ rg_name }}" {
  name     = "{{ rg_actual_name }}"
  location = "{{ location }}"
  tags     = local.tags
}

resource "azurerm_log_analytics_workspace" "{{ cluster_name }}_law" {
  name                = "{{ cluster_name }}-law"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  sku                 = "PerGB2018"
  retention_in_days   = {{ log_analytics_retention_days }}
  tags                = local.tags
}

resource "azurerm_kubernetes_cluster" "{{ cluster_name }}" {
  name                = "{{ cluster_name }}"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  dns_prefix          = "{{ dns_prefix }}"
  kubernetes_version  = "{{ kubernetes_version }}"
  sku_tier            = "Standard"
  role_based_access_control_enabled = true
  azure_active_directory_role_based_access_control {
    managed = true
  }
  identity {
    type = "SystemAssigned"
  }
  private_cluster_enabled        = {{ "true" if private_cluster else "false" }}
  public_network_access_enabled  = {{ "false" if private_cluster else "true" }}
  api_server_authorized_ip_ranges = {{ authorized_ip_ranges_literal }}

  default_node_pool {
    name                = "{{ node_pool_name }}"
    node_count          = {{ node_desired_count }}
    vm_size             = "{{ node_vm_size }}"
    vnet_subnet_id      = "{{ node_subnet_id }}"
    enable_auto_scaling = true
    min_count           = {{ node_min_count }}
    max_count           = {{ node_max_count }}
    tags                = local.tags
    orchestrator_version = "{{ kubernetes_version }}"
    max_pods            = {{ max_pods }}
  }

  network_profile {
    network_plugin      = "azure"
    network_policy      = "azure"
    load_balancer_sku   = "standard"
    outbound_type       = "loadBalancer"
    service_cidr        = "{{ service_cidr }}"
    dns_service_ip      = "{{ dns_service_ip }}"
    docker_bridge_cidr  = "{{ docker_bridge_cidr }}"
  }

  addon_profile {
    oms_agent {
      enabled                   = true
      log_analytics_workspace_id = azurerm_log_analytics_workspace.{{ cluster_name }}_law.id
    }
    azure_policy {
      enabled = {{ "true" if enable_azure_policy else "false" }}
    }
  }

  api_server_access_profile {
    authorized_ip_ranges = {{ authorized_ip_ranges_literal }}
  }

  tags = local.tags
}

resource "azurerm_monitor_diagnostic_setting" "{{ cluster_name }}_diag" {
  name                       = "{{ cluster_name }}-diag"
  target_resource_id         = azurerm_kubernetes_cluster.{{ cluster_name }}.id
  log_analytics_workspace_id = azurerm_log_analytics_workspace.{{ cluster_name }}_law.id

  log {
    category = "kube-apiserver"
    enabled  = true
  }
  log {
    category = "kube-audit"
    enabled  = true
  }
  log {
    category = "kube-audit-admin"
    enabled  = true
  }
  log {
    category = "kube-controller-manager"
    enabled  = true
  }
  log {
    category = "kube-scheduler"
    enabled  = true
  }
  log {
    category = "cluster-autoscaler"
    enabled  = true
  }
  log {
    category = "guard"
    enabled  = true
  }
  metric {
    category = "AllMetrics"
    enabled  = true
  }
}
