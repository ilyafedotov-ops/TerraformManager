// Generated by TerraformManager â€” AWS EKS IRSA service module
{% if backend %}
terraform {
  backend "s3" {
    bucket         = "{{ backend.bucket }}"
    key            = "{{ backend.key }}"
    region         = "{{ backend.region }}"
    dynamodb_table = "{{ backend.dynamodb_table }}"
    encrypt        = true
  }
}
{% endif %}

provider "aws" {
  region = "{{ region }}"
}

data "aws_eks_cluster" "{{ cluster_data_resource_name }}" {
  name = "{{ cluster_name }}"
}

data "aws_eks_cluster_auth" "{{ cluster_data_resource_name }}" {
  name = data.aws_eks_cluster.{{ cluster_data_resource_name }}.name
}

provider "kubernetes" {
  host                   = data.aws_eks_cluster.{{ cluster_data_resource_name }}.endpoint
  cluster_ca_certificate = base64decode(data.aws_eks_cluster.{{ cluster_data_resource_name }}.certificate_authority[0].data)
  token                  = data.aws_eks_cluster_auth.{{ cluster_data_resource_name }}.token
}

locals {
  common_tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }

  psa_labels = {
    "pod-security.kubernetes.io/enforce" = "{{ psa_enforce_level }}"
    "pod-security.kubernetes.io/audit"   = "{{ psa_audit_level }}"
    "pod-security.kubernetes.io/warn"    = "{{ psa_warn_level }}"
  }
}

{% if create_namespace %}
resource "kubernetes_namespace" "{{ namespace_resource_name }}" {
  metadata {
    name = "{{ namespace }}"
    labels = merge(
      local.psa_labels,
      {
        "app.kubernetes.io/managed-by" = "TerraformManager"
        "kubernetes.io/metadata.name"  = "{{ namespace }}"
      }
    )
  }
}

{% endif %}
resource "aws_iam_role" "{{ iam_role_resource_name }}" {
  name = "{{ iam_role_actual_name }}"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Federated = "{{ oidc_provider_arn }}"
        }
        Action = "sts:AssumeRoleWithWebIdentity"
        Condition = {
          "StringEquals" = {
            "{{ oidc_provider_host }}:sub" = "system:serviceaccount:{{ namespace }}:{{ service_account_name }}"
          }
          "StringLike" = {
            "{{ oidc_provider_host }}:aud" = "sts.amazonaws.com"
          }
        }
      }
    ]
  })

  tags = local.common_tags
}

resource "aws_iam_role_policy" "{{ iam_role_policy_resource_name }}" {
  name = "{{ iam_policy_name }}"
  role = aws_iam_role.{{ iam_role_resource_name }}.id

  policy = <<POLICY
{{ policy_document_json }}
POLICY
}

resource "kubernetes_service_account" "{{ service_account_resource_name }}" {
  metadata {
    name      = "{{ service_account_name }}"
    namespace = "{{ namespace }}"
    labels = {
      "app.kubernetes.io/name"       = "{{ service_account_name }}"
      "app.kubernetes.io/managed-by" = "TerraformManager"
    }
    annotations = {
      "eks.amazonaws.com/role-arn" = aws_iam_role.{{ iam_role_resource_name }}.arn
    }
  }
{% if create_namespace %}
  depends_on = [kubernetes_namespace.{{ namespace_resource_name }}]
{% endif %}
}

output "{{ iam_role_resource_name }}_arn" {
  description = "IAM role ARN for service account {{ service_account_name }}"
  value       = aws_iam_role.{{ iam_role_resource_name }}.arn
}

output "{{ service_account_resource_name }}_name" {
  description = "Kubernetes service account"
  value       = "${data.aws_eks_cluster.{{ cluster_data_resource_name }}.name}/{{ namespace }}/{{ service_account_name }}"
}
