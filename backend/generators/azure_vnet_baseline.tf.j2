// Generated by TerraformManager â€” Azure VNet baseline
{% if backend %}
terraform {
  backend "azurerm" {
    resource_group_name  = "{{ backend.resource_group }}"
    storage_account_name = "{{ backend.storage_account }}"
    container_name       = "{{ backend.container }}"
    key                  = "{{ backend.key }}"
  }
}
{% endif %}

provider "azurerm" {
  features {}
}

locals {
  tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

resource "azurerm_resource_group" "{{ rg_name }}" {
  name     = "{{ rg_actual_name }}"
  location = "{{ location }}"
  tags     = local.tags
}

resource "azurerm_log_analytics_workspace" "{{ name_prefix }}_law" {
  name                = "{{ name_prefix }}-law"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  sku                 = "PerGB2018"
  retention_in_days   = {{ log_analytics_retention_days }}
  tags                = local.tags
}

resource "azurerm_virtual_network" "{{ name_prefix }}_vnet" {
  name                = "{{ name_prefix }}-vnet"
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  location            = azurerm_resource_group.{{ rg_name }}.location
  address_space       = ["{{ address_space }}"]
  dns_servers         = []
  tags                = local.tags
}

resource "azurerm_subnet" "{{ name_prefix }}_workload" {
  name                 = "{{ name_prefix }}-workload"
  resource_group_name  = azurerm_resource_group.{{ rg_name }}.name
  virtual_network_name = azurerm_virtual_network.{{ name_prefix }}_vnet.name
  address_prefixes     = ["{{ workload_subnet_cidr }}"]
  private_endpoint_network_policies_enabled = true
  private_link_service_network_policies_enabled = false
}

resource "azurerm_subnet" "{{ name_prefix }}_bastion" {
  name                 = "{{ name_prefix }}-bastion"
  resource_group_name  = azurerm_resource_group.{{ rg_name }}.name
  virtual_network_name = azurerm_virtual_network.{{ name_prefix }}_vnet.name
  address_prefixes     = ["{{ bastion_subnet_cidr }}"]
}

resource "azurerm_network_security_group" "{{ name_prefix }}_nsg" {
  name                = "{{ name_prefix }}-workload-nsg"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  tags                = local.tags

  security_rule {
    name                       = "AllowManagementSSH"
    priority                   = 100
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_range     = "22"
    source_address_prefix      = "{{ allowed_management_cidr }}"
    destination_address_prefix = "*"
  }

  security_rule {
    name                       = "DenyInternetInbound"
    priority                   = 200
    direction                  = "Inbound"
    access                     = "Deny"
    protocol                   = "*"
    source_port_range          = "*"
    destination_port_range     = "*"
    source_address_prefix      = "Internet"
    destination_address_prefix = "*"
  }
}

resource "azurerm_subnet_network_security_group_association" "{{ name_prefix }}_workload_assoc" {
  subnet_id                 = azurerm_subnet.{{ name_prefix }}_workload.id
  network_security_group_id = azurerm_network_security_group.{{ name_prefix }}_nsg.id
}

resource "azurerm_network_watcher" "{{ name_prefix }}_nw" {
  name                = "{{ name_prefix }}-nw"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  tags                = local.tags
}

resource "azurerm_network_watcher_flow_log" "{{ name_prefix }}_flow_log" {
  name                 = "{{ name_prefix }}-flowlog"
  network_watcher_name = azurerm_network_watcher.{{ name_prefix }}_nw.name
  resource_group_name  = azurerm_network_watcher.{{ name_prefix }}_nw.resource_group_name
  network_security_group_id = azurerm_network_security_group.{{ name_prefix }}_nsg.id

  retention_policy {
    enabled = true
    days    = {{ flow_log_retention_days }}
  }

  traffic_analytics {
    enabled               = true
    workspace_id          = azurerm_log_analytics_workspace.{{ name_prefix }}_law.workspace_id
    workspace_region      = azurerm_log_analytics_workspace.{{ name_prefix }}_law.location
    workspace_resource_id = azurerm_log_analytics_workspace.{{ name_prefix }}_law.id
    interval_in_minutes   = 10
  }
}
