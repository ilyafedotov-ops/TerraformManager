// Generated by TerraformManager â€” Azure diagnostics baseline
{% if backend %}
terraform {
  backend "azurerm" {
    resource_group_name  = "{{ backend.resource_group }}"
    storage_account_name = "{{ backend.storage_account }}"
    container_name       = "{{ backend.container }}"
    key                  = "{{ backend.key }}"
  }
}
{% endif %}

provider "azurerm" {
  features {}
}

locals {
  tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

resource "azurerm_resource_group" "{{ rg_name }}" {
  name     = "{{ rg_actual_name }}"
  location = "{{ location }}"
  tags     = local.tags
}

resource "azurerm_log_analytics_workspace" "{{ law_name }}" {
  name                = "{{ law_actual_name }}"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  sku                 = "PerGB2018"
  retention_in_days   = {{ log_retention_days }}
  tags                = local.tags
}

{% if create_storage_account %}
resource "azurerm_storage_account" "{{ storage_name }}" {
  name                     = "{{ storage_actual_name }}"
  location                 = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name      = azurerm_resource_group.{{ rg_name }}.name
  account_tier             = "Standard"
  account_replication_type = "LRS"
  allow_blob_public_access  = false
  enable_https_traffic_only = true
  min_tls_version           = "TLS1_2"
  tags = local.tags
}
{% endif %}

{% for target in targets %}
resource "azurerm_monitor_diagnostic_setting" "{{ target.name }}" {
  name                       = "{{ diagnostic_prefix }}-{{ target.index }}"
  target_resource_id         = {% if target.id_is_literal %}{{ target.id }}{% else %}"{{ target.id }}"{% endif %}
  log_analytics_workspace_id = azurerm_log_analytics_workspace.{{ law_name }}.id
  {% if create_storage_account %}
  storage_account_id         = azurerm_storage_account.{{ storage_name }}.id
  {% endif %}

  {% for category in target.log_categories %}
  enabled_log {
    category = "{{ category }}"
  }
  {% endfor %}

  {% for metric in target.metric_categories %}
  enabled_metric {
    category = "{{ metric }}"
  }
  {% endfor %}
}
{% endfor %}

{% if health_alert %}
resource "azurerm_monitor_metric_alert" "{{ health_alert.resource_name }}" {
  name                = "{{ health_alert.name }}"
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  scopes              = [azurerm_log_analytics_workspace.{{ law_name }}.id]
  description         = "{{ health_alert.description }}"
  severity            = {{ health_alert.severity }}
  frequency           = "{{ health_alert.frequency }}"
  window_size         = "{{ health_alert.window_size }}"
  enabled             = true

  criteria {
    metric_namespace = "microsoft.operationalinsights/workspaces"
    metric_name      = "{{ health_alert.metric_name }}"
    aggregation      = "{{ health_alert.aggregation }}"
    operator         = "LessThan"
    threshold        = {{ health_alert.threshold }}
  }

  {% for action_group_id in health_alert.action_group_ids %}
  action {
    action_group_id = "{{ action_group_id }}"
  }
  {% endfor %}

  tags = local.tags
}
{% endif %}

output "log_analytics_workspace_id" {
  value = azurerm_log_analytics_workspace.{{ law_name }}.id
}

output "log_analytics_workspace_workspace_id" {
  value = azurerm_log_analytics_workspace.{{ law_name }}.workspace_id
}

{% if create_storage_account %}
output "diagnostics_storage_account_id" {
  value = azurerm_storage_account.{{ storage_name }}.id
}

output "diagnostics_storage_account_primary_blob_endpoint" {
  value = azurerm_storage_account.{{ storage_name }}.primary_blob_endpoint
}
{% endif %}

output "diagnostic_setting_ids" {
  value = {
  {% for target in targets %}
    "{{ target.name }}" = azurerm_monitor_diagnostic_setting.{{ target.name }}.id
  {% endfor %}
  }
}

output "diagnostic_target_resource_ids" {
  value = {
  {% for target in targets %}
    "{{ target.name }}" = azurerm_monitor_diagnostic_setting.{{ target.name }}.target_resource_id
  {% endfor %}
  }
}

{% if health_alert %}
output "diagnostics_health_alert_id" {
  value       = azurerm_monitor_metric_alert.{{ health_alert.resource_name }}.id
  description = "Metric alert monitoring Log Analytics ingestion health."
}
{% endif %}
