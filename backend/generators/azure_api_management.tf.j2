// Generated by TerraformManager â€” Azure API Management baseline
provider "azurerm" {
  features {}
}

locals {
  tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

resource "azurerm_resource_group" "{{ rg_name }}" {
  name     = "{{ rg_actual_name }}"
  location = "{{ location }}"
  tags     = local.tags
}

resource "azurerm_api_management" "{{ apim_name }}" {
  name                = "{{ apim_actual_name }}"
  location            = azurerm_resource_group.{{ rg_name }}.location
  resource_group_name = azurerm_resource_group.{{ rg_name }}.name
  publisher_name      = "{{ publisher_name }}"
  publisher_email     = "{{ publisher_email }}"
  sku_name            = "{{ sku_name }}"
  {% if capacity is not none %}
  capacity            = {{ capacity }}
  {% endif %}
  {% if zones_literal %}
  zones               = {{ zones_literal }}
  {% endif %}
  {% if virtual_network_type != "None" %}
  virtual_network_type = "{{ virtual_network_type }}"
  virtual_network_configuration {
    subnet_id = "{{ subnet_id }}"
  }
  {% endif %}
  identity {
    type = "{{ identity_type }}"
  }
  {% if custom_properties %}
  custom_properties = {
  {% for key, value in custom_properties.items() %}
    "{{ key }}" = "{{ value }}"
  {% endfor %}
  }
  {% endif %}
  protocols {
    enable_http2 = true
  }
  tags = local.tags
}

{% if diagnostics %}
resource "azurerm_monitor_diagnostic_setting" "{{ apim_name }}_diag" {
  name                       = "{{ apim_actual_name }}-diag"
  target_resource_id         = azurerm_api_management.{{ apim_name }}.id
  log_analytics_workspace_id = "{{ diagnostics.workspace_resource_id }}"

  dynamic "log" {
    for_each = {{ diagnostics.log_categories_literal }}
    content {
      category = log.value
      enabled  = true
    }
  }

  dynamic "metric" {
    for_each = {{ diagnostics.metric_categories_literal }}
    content {
      category = metric.value
      enabled  = true
    }
  }
}
{% endif %}

output "api_management_gateway_url" {
  value       = azurerm_api_management.{{ apim_name }}.gateway_url
  description = "Gateway URL for the API Management service."
}

output "api_management_identity_principal_id" {
  value       = azurerm_api_management.{{ apim_name }}.identity[0].principal_id
  description = "Managed identity principal ID."
}
