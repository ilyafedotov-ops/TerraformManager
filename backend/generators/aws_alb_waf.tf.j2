// Generated by TerraformManager â€” AWS ALB + WAF baseline
{% if backend %}
terraform {
  backend "s3" {
    bucket         = "{{ backend.bucket }}"
    key            = "{{ backend.key }}"
    region         = "{{ backend.region }}"
    dynamodb_table = "{{ backend.dynamodb_table }}"
    encrypt        = true
  }
}
{% endif %}

provider "aws" {
  region = "{{ region }}"
}

locals {
  common_tags = {
    ManagedBy   = "TerraformManager"
    Environment = "{{ environment }}"
    Owner       = "{{ owner_tag }}"
    CostCenter  = "{{ cost_center_tag }}"
  }
}

variable "alb_certificate_arn" {
  description = "ACM certificate ARN for HTTPS listener"
  type        = string
}

variable "target_group_arn" {
  description = "Existing target group ARN or create separately"
  type        = string
}

resource "aws_lb" "{{ alb_name }}" {
  name               = "{{ alb_actual_name }}"
  load_balancer_type = "application"
  security_groups    = {{ security_group_ids_literal }}
  subnets            = {{ subnet_ids_literal }}
  idle_timeout       = 60
  enable_deletion_protection = true
  enable_http2       = true
  internal           = {{ "true" if internal else "false" }}
  drop_invalid_header_fields = true
  {% if enable_access_logs %}
  access_logs {
    enabled = true
    {% if create_log_bucket %}
    bucket  = aws_s3_bucket.{{ log_bucket_resource_name }}.bucket
    {% else %}
    bucket  = "{{ log_bucket_name }}"
    {% endif %}
    prefix  = "{{ log_bucket_prefix }}"
  }
  {% endif %}

  tags = local.common_tags
}

{% if enable_access_logs and create_log_bucket %}
resource "aws_s3_bucket" "{{ log_bucket_resource_name }}" {
  bucket = "{{ log_bucket_name }}"
  acl    = "private"

  tags = local.common_tags
}

resource "aws_s3_bucket_public_access_block" "{{ log_bucket_resource_name }}" {
  bucket = aws_s3_bucket.{{ log_bucket_resource_name }}.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

resource "aws_s3_bucket_server_side_encryption_configuration" "{{ log_bucket_resource_name }}" {
  bucket = aws_s3_bucket.{{ log_bucket_resource_name }}.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}

resource "aws_s3_bucket_policy" "{{ log_bucket_resource_name }}_log_delivery" {
  bucket = aws_s3_bucket.{{ log_bucket_resource_name }}.id

  policy = <<POLICY
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AWSALBLogDelivery",
      "Effect": "Allow",
      "Principal": {
        "Service": "logdelivery.elb.amazonaws.com"
      },
      "Action": "s3:PutObject",
      "Resource": "${aws_s3_bucket.{{ log_bucket_resource_name }}.arn}/{{ log_bucket_prefix }}/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-acl": "bucket-owner-full-control"
        }
      }
    },
    {
      "Sid": "AWSALBLogDeliveryGetAcl",
      "Effect": "Allow",
      "Principal": {
        "Service": "logdelivery.elb.amazonaws.com"
      },
      "Action": [
        "s3:GetBucketAcl",
        "s3:ListBucket"
      ],
      "Resource": "${aws_s3_bucket.{{ log_bucket_resource_name }}.arn}"
    }
  ]
}
POLICY
}
{% endif %}

resource "aws_lb_listener" "{{ alb_name }}_https" {
  load_balancer_arn = aws_lb.{{ alb_name }}.arn
  port              = "443"
  protocol          = "HTTPS"
  ssl_policy        = "{{ ssl_policy }}"
  certificate_arn   = var.alb_certificate_arn

  default_action {
    type             = "forward"
    target_group_arn = var.target_group_arn
  }
}

resource "aws_lb_listener" "{{ alb_name }}_http" {
  load_balancer_arn = aws_lb.{{ alb_name }}.arn
  port              = "80"
  protocol          = "HTTP"

  default_action {
    type = "redirect"
    redirect {
      status_code = "HTTP_301"
      protocol    = "HTTPS"
      port        = "443"
    }
  }
}

resource "aws_wafv2_web_acl" "{{ waf_name }}" {
  name        = "{{ waf_actual_name }}"
  description = "WAF for ALB {{ alb_actual_name }}"
  scope       = "REGIONAL"
  default_action {
    allow {}
  }
  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = "{{ waf_actual_name }}"
    sampled_requests_enabled   = true
  }
  rule {
    name     = "AWS-AWSManagedRulesCommonRuleSet"
    priority = 1
    override_action {
      none {}
    }
    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesCommonRuleSet"
        vendor_name = "AWS"
      }
    }
    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesCommonRuleSet"
      sampled_requests_enabled   = true
    }
  }
  tags = local.common_tags
}

resource "aws_wafv2_web_acl_association" "{{ waf_name }}_assoc" {
  resource_arn = aws_lb.{{ alb_name }}.arn
  web_acl_arn  = aws_wafv2_web_acl.{{ waf_name }}.arn
}

resource "aws_lb_listener_rule" "{{ alb_name }}_default_headers" {
  listener_arn = aws_lb_listener.{{ alb_name }}_https.arn
  priority     = 100

  action {
    type             = "forward"
    target_group_arn = var.target_group_arn
  }

  condition {
    http_header {
      http_header_name = "X-Forwarded-Proto"
      values           = ["https"]
    }
  }
}
