{% extends "base.html" %}

{% block breadcrumbs %}
  <div class="text-xs font-semibold uppercase tracking-widest text-blueGray-400">
    <a class="hover:text-blue-500" href="/ui/dashboard">Home</a>
    <span class="px-2 text-blueGray-300">/</span>
    <a class="hover:text-blue-500" href="/ui/reports">Reports</a>
    <span class="px-2 text-blueGray-300">/</span>
    <span class="text-blue-500">{{ report_id }}</span>
  </div>
{% endblock %}

{% block page_header %}
  <h1 class="text-3xl font-bold leading-tight">Report {{ report_id }}</h1>
  <p class="mt-2 max-w-2xl text-sm font-medium text-blue-100">
    View the rich HTML output, navigate by section, and export formatted artefacts.
  </p>
{% endblock %}

{% block hero_actions %}
  <a
    class="inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/20"
    href="/reports/{{ report_id }}/html"
    target="_blank"
  >
    <i class="fas fa-external-link-alt text-xs"></i>
    Standalone HTML
  </a>
  <a
    class="inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/20"
    href="/reports/{{ report_id }}/csv"
  >
    <i class="fas fa-file-csv text-xs"></i>
    Download CSV
  </a>
{% endblock %}

{% block content %}
  <section class="flex flex-col gap-8 xl:flex-row">
    <article class="flex-1 rounded-3xl border border-blueGray-200 bg-white p-6 shadow-xl">
      <div id="report-html" class="tm-report-html">
        {{ report_html | safe }}
      </div>
    </article>
    <aside class="w-full xl:w-80">
      <div class="sticky top-24 rounded-3xl border border-blueGray-200 bg-white p-6 shadow-xl">
        <h2 class="text-sm font-semibold uppercase tracking-widest text-blueGray-400">On this page</h2>
        <nav id="toc" class="tm-toc mt-4 space-y-2"></nav>
        <div class="mt-6 flex flex-col gap-2 text-sm">
          <a
            class="inline-flex items-center gap-2 rounded-lg border border-blueGray-200 px-3 py-2 font-semibold text-blueGray-600 shadow-sm transition hover:border-blue-400 hover:text-blue-700"
            href="/ui/reports"
          >
            <i class="fas fa-arrow-left text-xs"></i>
            Back to list
          </a>
          <a
            class="inline-flex items-center gap-2 rounded-lg border border-blueGray-200 px-3 py-2 font-semibold text-blueGray-600 shadow-sm transition hover:border-blue-400 hover:text-blue-700"
            href="/ui/configs"
          >
            <i class="fas fa-sliders-h text-xs"></i>
            Apply Config
          </a>
        </div>
      </div>
    </aside>
  </section>

  <script>
    (function () {
      var root = document.getElementById('report-html');
      var toc = document.getElementById('toc');
      if (!root || !toc) return;
      var headings = root.querySelectorAll('h2, h3');
      if (!headings.length) {
        toc.innerHTML =
          '<div class="rounded-lg border border-dashed border-blueGray-200 bg-blueGray-50 px-4 py-3 text-sm text-blueGray-400">No headings found in this report.</div>';
        return;
      }
      var items = [];
      headings.forEach(function (h, idx) {
        if (!h.id) h.id = 'section-' + (idx + 1);
        var link = document.createElement('a');
        link.href = '#' + h.id;
        link.textContent = h.textContent || h.id;
        link.className =
          'block rounded-lg px-3 py-2 text-sm font-semibold text-blueGray-500 transition hover:bg-blue-50 hover:text-blue-600';
        if (h.tagName === 'H3') {
          link.className += ' ml-4 text-xs font-medium';
        }
        toc.appendChild(link);
        items.push({ heading: h, anchor: link });
      });

      var observer = new IntersectionObserver(
        function (entries) {
          entries.forEach(function (entry) {
            items.forEach(function (item) {
              if (item.heading === entry.target) {
                if (entry.isIntersecting) {
                  item.anchor.classList.add('tm-toc-active');
                } else {
                  item.anchor.classList.remove('tm-toc-active');
                }
              }
            });
          });
        },
        { rootMargin: '0px 0px -70% 0px', threshold: 0.15 }
      );

      items.forEach(function (item) {
        observer.observe(item.heading);
      });
    })();
  </script>
{% endblock %}

{% block page_actions %}
  <a
    href="/ui/reports"
    class="inline-flex items-center gap-2 rounded-lg border border-blueGray-200 bg-white px-4 py-2 text-sm font-semibold text-blueGray-600 shadow-sm transition hover:border-blue-400 hover:text-blue-700"
  >
    <i class="fas fa-arrow-left text-xs"></i>
    Back
  </a>
{% endblock %}
