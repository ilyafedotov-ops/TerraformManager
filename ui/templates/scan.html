{% extends "base.html" %}

{% block breadcrumbs %}
  <div class="text-xs font-semibold uppercase tracking-widest text-blueGray-400">
    <a class="hover:text-blue-500" href="/ui/dashboard">Home</a>
    <span class="px-2 text-blueGray-300">/</span>
    <span class="text-blue-500">Scan</span>
  </div>
{% endblock %}

{% block page_header %}
  <h1 class="text-3xl font-bold leading-tight">Scan</h1>
  <p class="mt-2 max-w-xl text-sm font-medium text-blue-100">
    Analyze Terraform files and directories locally, with optional Terraform validate hooks.
  </p>
{% endblock %}

{% block hero_actions %}
  <a
    href="/ui/reports"
    class="inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/20"
  >
    <i class="fas fa-clipboard-list text-xs"></i>
    Review Reports
  </a>
{% endblock %}

{% block content %}
  <section class="grid gap-8 xl:grid-cols-[minmax(0,520px)_minmax(0,1fr)]">
    <article class="rounded-3xl bg-white p-6 shadow-xl">
      <header>
        <h2 class="text-lg font-semibold text-blueGray-700">Run a scan</h2>
        <p class="mt-1 text-sm text-blueGray-400">
          Provide comma-separated paths. Terraform projects inside these paths will be evaluated.
        </p>
      </header>
      <form id="scanForm" class="mt-6 space-y-5">
        <div>
          <label for="scanPaths" class="block text-sm font-semibold uppercase tracking-wide text-blueGray-400">
            Paths
          </label>
          <input
            id="scanPaths"
            type="text"
            name="paths"
            value="sample"
            placeholder="sample, /path/to/your/project"
            class="mt-2 w-full rounded-2xl border border-blueGray-200 bg-blueGray-50 px-4 py-3 text-blueGray-800 placeholder-blueGray-400 shadow-sm transition focus:border-blue-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-200"
          />
        </div>
        <label class="flex items-center gap-3 rounded-2xl border border-blueGray-200 bg-blueGray-50 px-4 py-3 text-sm font-semibold text-blueGray-500 shadow-sm transition hover:border-blue-300">
          <input id="scanValidate" type="checkbox" name="terraform_validate" value="true" class="h-4 w-4 rounded border-blueGray-300 text-blue-600 focus:ring-blue-500" />
          Run <code class="rounded bg-blue-100 px-1 py-0.5 text-xs font-semibold text-blue-600">terraform validate</code>
        </label>
        <label class="flex items-center gap-3 rounded-2xl border border-blueGray-200 bg-blueGray-50 px-4 py-3 text-sm font-semibold text-blueGray-500 shadow-sm transition hover:border-blue-300">
          <input id="scanDryRun" type="checkbox" name="dry_run" value="true" class="h-4 w-4 rounded border-blueGray-300 text-blue-600 focus:ring-blue-500" />
          Do not persist the report (dry run)
        </label>
        <button
          type="submit"
          class="inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-3 text-sm font-semibold text-white shadow-lg transition hover:from-blue-600 hover:to-indigo-500 focus:outline-none focus:ring-4 focus:ring-blue-200"
        >
          <i class="fas fa-bolt text-xs"></i>
          Run Scan
        </button>
      </form>
    </article>
    <aside class="space-y-6">
      <div
        id="scan-result"
        class="rounded-3xl border border-dashed border-blueGray-200 bg-blueGray-50/60 p-6 text-sm text-blueGray-400 shadow-inner"
      >
        Results will appear here after a scan finishes.
      </div>
      <div class="rounded-3xl border border-blueGray-200 bg-white p-6 shadow-xl">
        <h3 class="text-lg font-semibold text-blueGray-700">cURL</h3>
        <p class="mt-2 text-sm text-blueGray-400">
          Reproduce this request via CLI. Replace <code>&lt;TOKEN&gt;</code> if your server requires authentication.
        </p>
        <pre class="tm-pre mt-4" id="curlSnippet"></pre>
      </div>
    </aside>
  </section>

  <script>
    (function () {
      var form = document.getElementById('scanForm');
      var panel = document.getElementById('scan-result');
      var indicator = document.getElementById('globalIndicator');
      if (!form || !panel) return;

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var paths = (document.getElementById('scanPaths').value || '')
          .split(',')
          .map(function (s) {
            return s.trim();
          })
          .filter(Boolean);
        var validate = !!document.getElementById('scanValidate').checked;
        var dryRun = !!document.getElementById('scanDryRun').checked;
        var payload = { paths: paths, terraform_validate: validate, save: !dryRun };
        var headers = { 'Content-Type': 'application/json' };
        try {
          var token = localStorage.getItem('tmApiToken');
          if (token) headers['Authorization'] = 'Bearer ' + token;
        } catch (err) {}
        if (indicator) indicator.classList.add('htmx-request');
        fetch('/scan', { method: 'POST', headers: headers, body: JSON.stringify(payload) })
          .then(function (r) {
            return r.json();
          })
          .then(function (data) {
            var summary = JSON.stringify(data.summary, null, 2);
            var severity = JSON.stringify(data.summary ? data.summary.severity_counts || {} : {}, null, 2);
            var html =
              '<div class="flex items-center gap-3 rounded-2xl border border-green-200 bg-green-50 px-4 py-3 text-green-600 shadow-sm">' +
              '<i class="fas fa-check-circle text-lg"></i>' +
              '<div class="text-sm font-semibold">Report ' +
              (data.id || '(not saved)') +
              ' â€” issues: ' +
              (data.summary && typeof data.summary.issues_found !== 'undefined'
                ? data.summary.issues_found
                : '?') +
              '</div></div>' +
              '<div class="mt-6 grid gap-6 lg:grid-cols-2">' +
              '<div><h4 class="text-xs font-semibold uppercase tracking-wide text-blueGray-400">Summary</h4>' +
              '<pre class="tm-pre mt-3">' +
              summary +
              '</pre></div>' +
              '<div><h4 class="text-xs font-semibold uppercase tracking-wide text-blueGray-400">Severity Counts</h4>' +
              '<pre class="tm-pre mt-3">' +
              severity +
              '</pre></div></div>';
            if (data.id) {
              html +=
                '<div class="mt-6 flex flex-wrap gap-3">' +
                '<a class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-500" href="/reports/' +
                data.id +
                '/html" target="_blank">' +
                '<i class="fas fa-external-link-alt text-xs"></i>Open HTML</a>' +
                '<a class="inline-flex items-center gap-2 rounded-xl border border-blue-200 px-4 py-2 text-sm font-semibold text-blue-600 shadow-sm transition hover:border-blue-400 hover:text-blue-700" href="/reports/' +
                data.id +
                '/csv">' +
                '<i class="fas fa-file-csv text-xs"></i>Download CSV</a>' +
                '</div>';
            }
            panel.classList.remove('text-blueGray-400');
            panel.classList.remove('border-dashed');
            panel.classList.add('bg-white');
            panel.classList.add('shadow-xl');
            panel.innerHTML = html;
          })
          .catch(function (err) {
            panel.innerHTML =
              '<div class="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-red-600">Error: ' +
              err +
              '</div>';
          })
          .finally(function () {
            if (indicator) indicator.classList.remove('htmx-request');
          });
      });
    })();
  </script>

  <script>
    (function () {
      var pathsEl = document.getElementById('scanPaths');
      var valEl = document.getElementById('scanValidate');
      var dryEl = document.getElementById('scanDryRun');
      var out = document.getElementById('curlSnippet');
      if (!pathsEl || !valEl || !dryEl || !out) return;
      function refresh() {
        var paths = (pathsEl.value || '')
          .split(',')
          .map(function (s) {
            return s.trim();
          })
          .filter(Boolean);
        var validate = !!valEl.checked;
        var dry = !!dryEl.checked;
        var payload = { paths: paths, terraform_validate: validate, save: !dry };
        var token = (function () {
          try {
            return localStorage.getItem('tmApiToken');
          } catch (e) {
            return null;
          }
        })();
        if (!token) token = '<TOKEN>';
        var cmd =
          'curl -s -X POST http://localhost:8787/scan \\\n' +
          '+  -H "Content-Type: application/json" \\\n' +
          '+  -H "Authorization: Bearer ' +
          token +
          '" \\\n' +
          '+  -d ' +
          JSON.stringify(JSON.stringify(payload));
        out.textContent = cmd;
      }
      ['input', 'change'].forEach(function (ev) {
        pathsEl.addEventListener(ev, refresh);
        valEl.addEventListener(ev, refresh);
        dryEl.addEventListener(ev, refresh);
      });
      refresh();
    })();
  </script>
{% endblock %}

{% block page_actions %}
  <a
    href="/ui/reports"
    class="inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-white px-4 py-2 text-sm font-semibold text-blue-600 shadow-sm transition hover:border-blue-400 hover:text-blue-700"
  >
    <i class="fas fa-clipboard-list text-xs"></i>
    View Reports
  </a>
{% endblock %}
