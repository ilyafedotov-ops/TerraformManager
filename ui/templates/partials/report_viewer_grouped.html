{% if findings and findings|length > 0 %}
  {% set groups = {} %}
  {% for f in findings %}
    {% set _ = groups.setdefault(f.rule, []).append(f) %}
  {% endfor %}
  <div class="space-y-4">
    {% for rule, items in groups.items() %}
      {% set sev_counts = {} %}
      {% for it in items %}
        {% set s = (it.severity or 'LOW')|upper %}
        {% set _ = sev_counts.__setitem__(s, (sev_counts.get(s, 0) + 1)) %}
      {% endfor %}
      {% set total = items|length %}
      <details class="group overflow-hidden rounded-2xl border border-blueGray-200 bg-white shadow" open>
        <summary class="flex cursor-pointer flex-col gap-4 px-5 py-4 text-sm font-semibold text-blueGray-600 transition group-open:bg-blueGray-50 md:flex-row md:items-center">
          <span class="flex items-center gap-3">
            <code class="rounded bg-blueGray-100 px-2 py-1 text-xs text-blueGray-500">{{ rule }}</code>
            <span class="rounded-full bg-blue-100 px-3 py-1 text-xs font-semibold text-blue-600">
              {{ total }} finding{{ '' if total == 1 else 's' }}
            </span>
          </span>
          <span class="flex-1">
            <div class="flex h-2 w-full overflow-hidden rounded-full bg-blueGray-100">
              {% for sev, cnt in sev_counts.items() %}
                {% set pct = (cnt * 100 // (total or 1)) %}
                {% set bar_class = 'bg-blue-400' %}
                {% if sev == 'CRITICAL' %}
                  {% set bar_class = 'bg-red-500' %}
                {% elif sev == 'HIGH' %}
                  {% set bar_class = 'bg-orange-400' %}
                {% elif sev == 'MEDIUM' %}
                  {% set bar_class = 'bg-yellow-400' %}
                {% endif %}
                <div class="h-full {{ bar_class }}" style="width: {{ pct }}%; flex: 0 0 {{ pct }}%"></div>
              {% endfor %}
            </div>
          </span>
          <span class="ml-auto flex items-center gap-3 text-xs font-semibold text-blueGray-400">
            {% for sev, cnt in sev_counts.items() %}
              <span class="inline-flex items-center gap-1 rounded-full bg-blueGray-100 px-2 py-1">
                <span>{{ sev }}</span>
                <span class="text-blueGray-500">{{ cnt }}</span>
              </span>
            {% endfor %}
          </span>
        </summary>
        <div class="border-t border-blueGray-100 bg-white px-5 py-4">
          <div class="tm-table-wrapper">
            <table class="tm-table">
              <thead>
                <tr>
                  <th>Severity</th>
                  <th>Title</th>
                  <th>File</th>
                  <th>Line</th>
                </tr>
              </thead>
              <tbody>
                {% for f in items %}
                  {% set sev = (f.severity or 'LOW')|upper %}
                  <tr>
                    <td><span class="tm-tag tm-tag-{{ sev|lower }}">{{ sev }}</span></td>
                    <td class="font-semibold text-blueGray-600">{{ f.title }}</td>
                    <td class="text-sm text-blueGray-400">{{ f.file }}</td>
                    <td class="text-sm text-blueGray-500">{{ f.line or 1 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </details>
    {% endfor %}
  </div>
{% else %}
  <div class="rounded-2xl border border-dashed border-blueGray-200 bg-blueGray-50 px-6 py-8 text-center text-sm text-blueGray-400">
    No findings with the current filters.
  </div>
{% endif %}
