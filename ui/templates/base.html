<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Terraform Manager</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="stylesheet" href="/static/css/notus-tailwind.css" />
    <link rel="stylesheet" href="/static/css/fontawesome.min.css" />
    <link rel="stylesheet" href="/static/app.css" />
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    <script>
      // Theme bootstrap
      (function () {
        try {
          var saved = localStorage.getItem('tmTheme');
          if (saved === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
          }
        } catch (e) {}
      })();

      // Attach API token to HTMX requests (if present)
      document.addEventListener('htmx:configRequest', function (evt) {
        try {
          var token = localStorage.getItem('tmApiToken');
          if (token) {
            evt.detail.headers['Authorization'] = 'Bearer ' + token;
          }
        } catch (e) {}
      });

      // LLM test helper
      function tmTestLLM(live) {
        var el = document.getElementById('llm-test-result');
        if (el) el.textContent = 'Testing…';
        var headers = { 'Content-Type': 'application/json' };
        try {
          var t = localStorage.getItem('tmApiToken');
          if (t) headers['Authorization'] = 'Bearer ' + t;
        } catch (e) {}
        var provEl = document.getElementById('llmProvider');
        var prov = provEl ? provEl.value : null;
        if (live && (!prov || prov === 'off')) {
          if (el) el.textContent = 'Enable provider first.';
          return;
        }
        fetch('/settings/llm/test', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({ live: !!live }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (!el) return;
            el.textContent = '';
            if (data.ok) {
              el.textContent =
                data.stage === 'ping' ? 'Live ping OK' : 'Config OK';
            } else {
              el.textContent = 'Error: ' + (data.error || 'unknown');
            }
          })
          .catch((err) => {
            if (el) el.textContent = 'Error: ' + err;
          });
      }
      window.tmTestLLM = tmTestLLM;

      // Browser token save helper
      function tmSaveToken() {
        var input = document.getElementById('apiTokenInput');
        var val = ((input && input.value) || '').trim();
        if (!val) {
          localStorage.removeItem('tmApiToken');
          alert('Cleared');
        } else {
          localStorage.setItem('tmApiToken', val);
          alert('Saved');
        }
      }
      window.tmSaveToken = tmSaveToken;
    </script>
  </head>
  <body class="bg-blueGray-100 text-blueGray-800">
    <div id="globalIndicator" class="tm-indicator htmx-indicator">Loading…</div>
    <div class="min-h-screen bg-blueGray-100">
      <aside
        id="tmSidebar"
        class="fixed inset-y-0 left-0 z-30 w-64 -translate-x-full transform border-r border-blueGray-200 bg-white shadow-xl transition-transform duration-200 ease-out md:translate-x-0"
        aria-label="Sidebar"
      >
        <div class="flex h-full flex-col">
          <div class="flex items-center justify-between px-6 py-5 border-b border-blueGray-100">
            <a
              class="flex items-center gap-2 text-lg font-bold uppercase text-blueGray-700 tracking-wide"
              href="/ui/dashboard"
            >
              <img src="/static/logo.svg" alt="Terraform Manager logo" class="h-8 w-8" />
              Terraform Manager
            </a>
            <button
              id="tmSidebarClose"
              type="button"
              class="inline-flex h-10 w-10 items-center justify-center rounded-lg border border-transparent text-blueGray-400 hover:text-blueGray-600 focus:outline-none md:hidden"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <nav class="flex-1 overflow-y-auto px-4 py-6">
            <div class="mb-4 text-xs font-semibold uppercase tracking-widest text-blueGray-400">
              Main Navigation
            </div>
            <ul class="space-y-2">
              <li>
                <a
                  href="/ui/dashboard"
                  class="tm-nav-link {% if request.url.path.startswith('/ui/dashboard') %}tm-nav-active{% endif %}"
                >
                  <i class="fas fa-tv mr-3 text-sm"></i>
                  <span>Dashboard</span>
                </a>
              </li>
              <li>
                <a
                  href="/ui/scan"
                  class="tm-nav-link {% if request.url.path.startswith('/ui/scan') %}tm-nav-active{% endif %}"
                >
                  <i class="fas fa-search mr-3 text-sm"></i>
                  <span>Scan</span>
                </a>
              </li>
              <li>
                <a
                  href="/ui/reports"
                  class="tm-nav-link {% if request.url.path.startswith('/ui/reports') %}tm-nav-active{% endif %}"
                >
                  <i class="fas fa-clipboard-list mr-3 text-sm"></i>
                  <span>Reports</span>
                </a>
              </li>
              <li>
                <a
                  href="/ui/configs"
                  class="tm-nav-link {% if request.url.path.startswith('/ui/configs') %}tm-nav-active{% endif %}"
                >
                  <i class="fas fa-sliders-h mr-3 text-sm"></i>
                  <span>Configs</span>
                </a>
              </li>
              <li>
                <a
                  href="/ui/knowledge"
                  class="tm-nav-link {% if request.url.path.startswith('/ui/knowledge') %}tm-nav-active{% endif %}"
                >
                  <i class="fas fa-book mr-3 text-sm"></i>
                  <span>Knowledge</span>
                </a>
              </li>
              <li>
                <a
                  href="/ui/settings"
                  class="tm-nav-link {% if request.url.path.startswith('/ui/settings') %}tm-nav-active{% endif %}"
                >
                  <i class="fas fa-cog mr-3 text-sm"></i>
                  <span>Settings</span>
                </a>
              </li>
            </ul>
          </nav>
          <div class="px-6 py-5 border-t border-blueGray-100 text-xs text-blueGray-400">
            © Terraform Manager — v{{ APP_VERSION }}
            {% if FOOTER_LINKS %}
              <div class="mt-2 space-y-1">
                {% for link in FOOTER_LINKS %}
                  <a class="block text-blueGray-500 hover:text-blueGray-700" target="_blank" href="{{ link.href }}">{{ link.title }}</a>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </aside>
      <div class="md:ml-64">
        <nav class="sticky top-0 z-20 bg-white shadow">
          <div class="flex items-center justify-between px-4 py-4 md:px-8">
            <div class="flex items-center gap-3">
              <button
                id="tmSidebarToggle"
                type="button"
                class="inline-flex h-10 w-10 items-center justify-center rounded-lg border border-blueGray-200 text-blueGray-500 transition hover:bg-blueGray-50 focus:outline-none md:hidden"
              >
                <i class="fas fa-bars text-lg"></i>
              </button>
              <div>
                {% block breadcrumbs %}
                  <span class="text-xs font-semibold uppercase tracking-widest text-blueGray-400">Home</span>
                {% endblock %}
              </div>
            </div>
            <div class="flex items-center gap-3">
              {% block page_actions %}
              {% endblock %}
              <button
                class="inline-flex items-center gap-2 rounded-lg border border-blueGray-200 px-4 py-2 text-sm font-semibold text-blueGray-600 transition hover:border-blue-500 hover:text-blue-600"
                type="button"
                id="themeToggle"
              >
                <i class="fas fa-adjust"></i>
                <span>Toggle Theme</span>
              </button>
            </div>
          </div>
        </nav>
        <header class="px-4 py-6 md:px-8 md:py-8">
          <div class="rounded-2xl bg-gradient-to-r from-blue-500 to-indigo-600 p-6 text-white shadow-lg">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div>
                {% block page_header %}
                {% endblock %}
              </div>
              <div class="hidden sm:flex sm:items-center sm:gap-3">
                {% block hero_actions %}
                {% endblock %}
              </div>
            </div>
          </div>
        </header>
        <main class="px-4 pb-10 md:px-8">
          <div class="mx-auto w-full">
            {% block content %}
            {% endblock %}
          </div>
        </main>
        <footer class="px-4 pb-6 text-sm text-blueGray-400 md:px-8">
          <div class="rounded-xl border border-blueGray-200 bg-white px-6 py-4 shadow">
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
              <div>
                © Terraform Manager — v{{ APP_VERSION }}
              </div>
              {% if FOOTER_LINKS %}
                <div class="flex flex-wrap gap-3">
                  {% for link in FOOTER_LINKS %}
                    <a class="text-blueGray-500 transition hover:text-blue-500" target="_blank" href="{{ link.href }}">{{ link.title }}</a>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </footer>
      </div>
    </div>
    <script>
      // Theme toggler
      (function () {
        var btn = document.getElementById('themeToggle');
        if (btn) {
          btn.addEventListener('click', function () {
            var root = document.documentElement;
            var dark = root.getAttribute('data-theme') === 'dark';
            if (dark) {
              root.removeAttribute('data-theme');
              localStorage.setItem('tmTheme', 'light');
            } else {
              root.setAttribute('data-theme', 'dark');
              localStorage.setItem('tmTheme', 'dark');
            }
          });
        }

        var sidebar = document.getElementById('tmSidebar');
        var openBtn = document.getElementById('tmSidebarToggle');
        var closeBtn = document.getElementById('tmSidebarClose');

        function openSidebar() {
          if (!sidebar) return;
          sidebar.classList.remove('-translate-x-full');
        }

        function closeSidebar() {
          if (!sidebar) return;
          sidebar.classList.add('-translate-x-full');
        }

        if (openBtn) openBtn.addEventListener('click', openSidebar);
        if (closeBtn) closeBtn.addEventListener('click', closeSidebar);

        document.addEventListener('keydown', function (evt) {
          if (evt.key === 'Escape') closeSidebar();
        });
      })();
    </script>
  </body>
</html>
